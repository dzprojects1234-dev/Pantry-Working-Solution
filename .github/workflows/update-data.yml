name: Update Stock Data

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Python
        uses: actions/setup-python@v4
        with:
          python-version: '3.x'
      
      - name: Fetch data from Supabase
        env:
          SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
          SUPABASE_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
        run: |
          mkdir -p public/data
          
          python -c "
import os, json, requests
from datetime import datetime

url = os.environ.get('SUPABASE_URL')
key = os.environ.get('SUPABASE_KEY')

result = {
    'lastUpdated': datetime.utcnow().isoformat() + 'Z',
    'data': []
}

print('Starting data fetch...')

if url and key:
    try:
        headers = {
            'apikey': key,
            'Authorization': f'Bearer {key}',
            'Content-Type': 'application/json'
        }
        
        # Try to fetch from 'Items' table
        try:
            response = requests.get(
                f'{url}/rest/v1/Items?select=*&order=date.desc',
                headers=headers,
                timeout=10
            )
            
            if response.status_code == 200:
                result['data'] = response.json()
                print(f'‚úÖ Success! Found {len(result[\"data\"])} items')
            else:
                print(f'‚ö†Ô∏è API returned {response.status_code}')
                print(f'Response: {response.text[:200]}')
        except Exception as e:
            print(f'‚ö†Ô∏è Error fetching: {e}')
    except Exception as e:
        print(f'‚ö†Ô∏è Setup error: {e}')
else:
    print('‚ö†Ô∏è Missing credentials')

# If no data, use sample
if not result['data']:
    print('üìù Using sample data')
    result['data'] = [
        {'item_name': 'Milo', 'new_quantity': 4, 'previous_quantity': 2, 'date': '2025-12-24T22:33:00Z'},
        {'item_name': 'Tea Powder', 'new_quantity': 12, 'previous_quantity': 8, 'date': '2025-12-24T22:34:00Z'},
        {'item_name': 'Tea Bags', 'new_quantity': 10, 'previous_quantity': 12, 'date': '2025-12-20T23:57:00Z'}
    ]

# Save to file
with open('public/data/stock-data.json', 'w') as f:
    json.dump(result, f, indent=2)

print('üìÅ Data saved to stock-data.json')
          "
      
      - name: Copy index.html
        run: |
          if [ -f "index.html" ]; then
            cp index.html public/
            echo "‚úÖ Copied index.html"
          fi
      
      - name: Deploy to GitHub Pages
        uses: peaceiris/actions-gh-pages@v3
        with:
          github_token: ${{ secrets.GITHUB_TOKEN }}
          publish_dir: ./public
