name: Update Stock Data from Supabase

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    environment: production
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Fetch data from Supabase
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "ğŸ” Fetching data from Supabase..."
        
        # Create data directory
        mkdir -p public/data
        
        # Fetch from your table - CHANGE 'your_table_name' to your actual table name
        # Based on your screenshot, it might be 'inventory_changes' or similar
        echo "ğŸ“Š Fetching from: $SUPABASE_URL"
        
        # Try to fetch data
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          "$SUPABASE_URL/rest/v1/inventory_changes?select=*&order=date.desc" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json")
        
        # Separate body and status code
        BODY=$(echo "$RESPONSE" | head -n -1)
        STATUS_CODE=$(echo "$RESPONSE" | tail -n 1)
        
        echo "Status code: $STATUS_CODE"
        
        if [ "$STATUS_CODE" = "200" ]; then
          echo "âœ… Successfully fetched data"
          echo '{"lastUpdated": "'$(date -u +"%Y-%m-%dT%H:%M:%SZ")'", "data": '"$BODY"'}' > public/data/stock-data.json
        else
          echo "âš ï¸ Failed to fetch data. Using sample data."
          echo "Response: $BODY"
          
          # Create sample data
          cat > public/data/stock-data.json << 'EOF'
{
  "lastUpdated": "$(date -u +"%Y-%m-%dT%H:%M:%SZ")",
  "data": [
    {"id": 1, "item_name": "Milo", "new_quantity": 4, "previous_quantity": 2, "date": "2025-12-24T22:33:00Z"},
    {"id": 2, "item_name": "Tea Powder", "new_quantity": 12, "previous_quantity": 8, "date": "2025-12-24T22:34:00Z"},
    {"id": 3, "item_name": "Tea Bags", "new_quantity": 10, "previous_quantity": 12, "date": "2025-12-20T23:57:00Z"},
    {"id": 5, "item_name": "Susu Pekat", "new_quantity": 314, "previous_quantity": 214, "date": "2025-12-24T22:49:00Z"},
    {"id": 6, "item_name": "Susu Cair", "new_quantity": 97, "previous_quantity": 47, "date": "2025-12-24T22:52:00Z"}
  ]
}
EOF
          # Fix the date placeholder
          sed -i "s/\\\$(date[^)]*)/$(date -u +"%Y-%m-%dT%H:%M:%SZ")/g" public/data/stock-data.json
        fi
        
        echo "ğŸ“ Data saved to public/data/stock-data.json"
        echo "First 200 chars:"
        head -c 200 public/data/stock-data.json && echo "..."
        
    - name: Copy index.html to public folder
      run: |
        if [ -f "index.html" ]; then
          cp index.html public/
          echo "âœ… Copied index.html"
        else
          echo "âš ï¸ index.html not found in root"
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
