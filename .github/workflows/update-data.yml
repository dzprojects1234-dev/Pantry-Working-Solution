name: Update Stock Data from Supabase

on:
  schedule:
    - cron: '*/15 * * * *'  # Every 15 minutes
  workflow_dispatch:
  push:
    branches: [ main ]

permissions:
  contents: write

jobs:
  update-data:
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout repository
      uses: actions/checkout@v4
      
    - name: Fetch data from Supabase
      env:
        SUPABASE_URL: ${{ secrets.SUPABASE_URL }}
        SUPABASE_ANON_KEY: ${{ secrets.SUPABASE_ANON_KEY }}
      run: |
        echo "ðŸ” Fetching data from Supabase..."
        
        # Create data directory
        mkdir -p public/data
        
        # Get current date
        CURRENT_DATE=$(date -u +"%Y-%m-%dT%H:%M:%SZ")
        
        # Try to fetch data
        echo "ðŸ“Š Fetching from: $SUPABASE_URL"
        
        # Make the API call
        RESPONSE=$(curl -s -w "\n%{http_code}" \
          "$SUPABASE_URL/rest/v1/inventory_changes?select=*&order=date.desc" \
          -H "apikey: $SUPABASE_ANON_KEY" \
          -H "Authorization: Bearer $SUPABASE_ANON_KEY" \
          -H "Content-Type: application/json" 2>/dev/null || echo "CURL_FAILED\n000")
        
        # Separate body and status code
        BODY=$(echo "$RESPONSE" | head -n -1)
        STATUS_CODE=$(echo "$RESPONSE" | tail -n 1)
        
        echo "Status code: $STATUS_CODE"
        
        if [ "$STATUS_CODE" = "200" ] && [ "$BODY" != "CURL_FAILED" ]; then
          echo "âœ… Successfully fetched data"
          cat > public/data/stock-data.json << EOF
{
  "lastUpdated": "$CURRENT_DATE",
  "data": $BODY
}
EOF
        else
          echo "âš ï¸ Failed to fetch data. Using sample data."
          echo "Response: $BODY"
          
          # Create sample data (FIXED SYNTAX)
          cat > public/data/stock-data.json << EOF
{
  "lastUpdated": "$CURRENT_DATE",
  "data": [
    {"id": 1, "item_name": "Milo", "new_quantity": 4, "previous_quantity": 2, "date": "2025-12-24T22:33:00Z"},
    {"id": 2, "item_name": "Tea Powder", "new_quantity": 12, "previous_quantity": 8, "date": "2025-12-24T22:34:00Z"},
    {"id": 3, "item_name": "Tea Bags", "new_quantity": 10, "previous_quantity": 12, "date": "2025-12-20T23:57:00Z"},
    {"id": 5, "item_name": "Susu Pekat", "new_quantity": 314, "previous_quantity": 214, "date": "2025-12-24T22:49:00Z"},
    {"id": 6, "item_name": "Susu Cair", "new_quantity": 97, "previous_quantity": 47, "date": "2025-12-24T22:52:00Z"}
  ]
}
EOF
        fi
        
        echo "ðŸ“ Data saved to public/data/stock-data.json"
        
    - name: Copy index.html to public folder
      run: |
        if [ -f "index.html" ]; then
          cp index.html public/
          echo "âœ… Copied index.html"
        else
          echo "âš ï¸ index.html not found in root"
          # Create a basic index.html
          cat > public/index.html << 'EOF'
          <!DOCTYPE html>
          <html>
          <head><title>Inventory Dashboard</title></head>
          <body><h1>Loading...</h1><p>Please update index.html in repository root</p></body>
          </html>
          EOF
        fi
        
    - name: Deploy to GitHub Pages
      uses: peaceiris/actions-gh-pages@v3
      with:
        github_token: ${{ secrets.GITHUB_TOKEN }}
        publish_dir: ./public
